document.addEventListener("DOMContentLoaded",function(){const l=document.querySelector('meta[name="csrf-token"]').getAttribute("content");a(0),document.querySelectorAll(".question-btn").forEach(e=>{e.addEventListener("click",function(){const t=parseInt(this.dataset.index);a(t),u(t)})});function a(e){const t=questions[e];document.querySelector(".situation-text").textContent=t.situation,document.querySelector(".question-text").textContent=t.question;const o=document.getElementById("reponses");o.innerHTML="",["A","B","C","D"].forEach((n,r)=>{const h=t.propositions[r]??"Proposition",s=document.createElement("button");s.className="btn w-100 p-3 rounded bg-white text-start text-dark choix-reponse",s.dataset.reponse=n,s.dataset.index=e,s.innerHTML=`<span class="fw-bold fs-4 me-2">${n}</span> ${h}`,s.addEventListener("click",()=>m(n,e));const d=document.createElement("div");d.className="col-md-5",d.appendChild(s),o.appendChild(d)}),u(e)}let c=questions.map((e,t)=>reponses[e.id]?null:t).filter(e=>e!==null);function m(e,t){const o=questions[t].id;fetch("/comprehension_ecrite/repondre",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":l},body:JSON.stringify({question_id:o,reponse:e,test_type:document.getElementById("testType").value})}).then(n=>n.json()).then(n=>{if(c=c.filter(r=>r!==t),c.length>0){const r=c[0];setTimeout(()=>a(r),500)}else setTimeout(()=>{alert("🎉 Test terminé !"),enregistrerResultatFinalEtRediriger()},500)}).catch(n=>console.error("Erreur AJAX:",n))}function u(e){document.querySelectorAll(".question-btn").forEach((t,o)=>{t.classList.remove("btn-success","btn-danger","btn-secondary"),t.classList.add(o===e?"btn-success":"btn-secondary")})}let i=3600;const p=document.getElementById("timer"),f=setInterval(()=>{const e=String(Math.floor(i/60)).padStart(2,"0"),t=String(i%60).padStart(2,"0");p.textContent=`${e}:${t}`,i--,i<0&&(clearInterval(f),alert("⏱️ Temps écoulé !"),window.location.href="/comprehension_ecrite/resultat")},1e3)});
